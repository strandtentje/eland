{
	personbyattr = f"../person/view.conf@byattributevalue";

	settoken = { value = "token" };

	teammembers = <personbyattr>(
				view = "simple", name = "token", remap = settoken);
	messages = {
		notsaved = Template(f"templates/notsaved.html");
		saved = Template(f"templates/saved.html");
	};

	saveteam = DataReader(f"queries/GetTeamByName.sql", connection = "stortneer") {
		none->DataWriter(f"queries/SetTeamName.sql", connection = "stortneer") {
			changed_0->messages.notsaved; changed_1->messages.saved;
		};
		single->Template(f"templates/notunique.html");
	};

	editteam = HttpMethod() {
		get->Template(f"templates/viewteam.html") {
			form->Template(f"templates/titleform.html");
			members->teammembers;
		};
		post->Template(f"templates/viewteam.html") {
			form->WwwForm(fieldlist = ["title"]) {
				title->NameField(required = true) {
					successful->saveteam;
					failure->Template(f"templates/teamnamerequired.html");
				};
				mapped->Template(f"templates/titleform.html");
			};
			members->teammembers;
		};
	};

	viewteam = Template(f"templates/teamitem.html") {
		members-><personbyattr>(
			view = "extended", name = "token", remap = settoken);						
	};

	instances = {
		admin = HttpMethod() {
			get->Template(f"templates/teamlist.html") {
				entered->DataReader(f"queries/GetEnteredTeams.sql", connection = "stortneer") {
					iterator->Template(f"templates/stagebutton.html") {
						team->viewteam;
					};
				};
				staged->DataReader(f"queries/GetStagedTeams.sql", connection = "stortneer") {
					iterator->Template(f"templates/enterbutton.html") {
						team->viewteam;
					};
				};
			};
			post->Check() { 
				subject->WwwForm(fieldlist = ["id"]) {
					id->NumberField(required = true) {
						failure->FailCheck(); successful->StubService();
					};
					mapped->CheckCheck() {
						successful->Dir() {
							enter->DataWriter(f"queries/SetTeamEntered.sql", connection = "stortneer") {
								changed_0->messages.notsaved; changed_1->messages.saved;
							};
							unenter->DataWriter(f"queries/ResetTeamEntered.sql", connection = "stortneer") {
								changed_0->messages.notsaved; changed_1->messages.saved;
							};
							purge->DataReader(f"queries/PurgeTeam.sql", connection = "stortneer") {
								changed_0->messages.notsaved; changed_1->messages.saved;			
							};	
						};
					};
				};
			};
		};

		create = DataReader(f"queries/ProduceToken.sql", connection = "stortneer") {
			single->DataReader(f"queries/GetTeamByToken.sql", connection = "stortneer") {
				none-><f"../person/control.conf@updatepersonattribute">(
					name = "token", remap = { value = "token" }
				) & DataReader(f"queries/AddTeam.sql", connection = "stortneer") {
					single->editteam;
				};
				single-><f"main.conf@create">;
			};
		};

		modify = DataReader(f"queries/GetTeamByToken.sql", connection = "stortneer") {
			none->instances.create;
			single->editteam;
		};
	};
}